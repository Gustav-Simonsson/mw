<div class=main>

  <h3>Cashout</h3>

  <p>
    <ll>
      <li>
        $HEADLINE
      </li>
    </ll>
  </p>

    <li><b>1. To Address (receives winnings) (base58check) :</b>
    <br />
    <p style="font-family: monospace; white-space: pre;"> $TO_ADDRESS </p>
    </li>

    <li><b>2. Revealed Oracle RSA Private Key (PEM) :</b>
    <br />
    <p id=oracle_privkey style="font-family: monospace; white-space: pre;"><font color=red>[A key should appear here.]</font></p>
    </li>

    <li><b>3. Encrypted Event Private Key (Hex) :</b>
    <br />
    <p style="font-family: monospace; white-space: pre;"> $ENC_EVENT_PRIVKEY </p>
    </li>

    <li><b>4. T3 Raw (Hex) :</b>
    <br />
    <p style="font-family: monospace; white-space: pre;"> $T3-RAW </p>
    </li>

    <li><b>5. T3 Sighash (Hex) :</b>
    <br />
    <p style="font-family: monospace; white-space: pre;"> $T3-SIGHASH </p>
    </li>

  <h4>Instructions</h4>
  <p>
    <ll>
      <li>
        Please paste your EC PRIVATE KEY that you copied earlier:
        <textarea id=signer_ec_privkey class=mark></textarea>
        <br />
      </li>
      <li>
        Please paste your RSA PRIVATE KEY that you copied earlier:
        <textarea id=signer_rsa_privkey class=mark></textarea>
        <br />
      </li>

      <li>
        Then, please click 'sign'.
      </li>
    </ll>
  </p>

  <button class=mark onClick="sign()">sign</button>

  <p>
    <a href=wrapup.html>cashout</a>
  </p>

  <hr />

  <h4>Notes</h4>
  <p>
    <ul>
      <li>
        Technically, what happens here is this:
        <ul>
          <li>
             the double-encrypted WINNING KEY is now decrypted
            <ul>
              <li>
                 .. using your personal, one time SECURITY KEY
              </li>
              <li>
                 .. and the ORACLE KEY that was released at event outcome
              </li>
              <li>
                 the resulting is the decrypted WINNING KEY.
              </li>
            </ul>
          </li>
          <li>
             This is used to unlock the waged amount in the betting contract
          </li>
            <ul>
              <li>
                 .. signing it with this WINNING KEY and also
              </li>
              <li>
                 .. signing it with your SIGNATURE KEY
              </li>
              <li>
                 .. to transfer the amount to the address you entered on the previous page.
              </li>
            </ul>
          <li>
             After you click 'sign' the Bitcoins should arrive in your wallet after about 10 minutes.
          </li>
        </ul>
      </li>
      <li>
        We never held the money, it was locked into the blockchain.
      </li>
      <li>
        The money is fully yours the moment you receive the WINNING KEY.
      </li>
        <ul>
          <li>
            .. even if you do not execute this page, you safely own the won Bitcoins
          </li>
          <li>
            .. this page mererly helps you to put the won Bitcoins back into your wallet
          </li>
          <li>
            .. but note that you might loose Bitcoins that are not moved for 10 years, or less
          </li>
        </ul>
      <li>
        Ajax call: <p id=url></p>
      </li>
      <li>
        Ajax result: <p id=result></p>
      </li>

    </ul>
  </p>

</div>


  <!-- LIBS -->

  <!-- BitcoinJS -->

  <script type="text/javascript" src="../bitcoinjs/crypto-js/crypto.js"></script>
  <script type="text/javascript" src="../bitcoinjs/crypto-js/sha256.js"></script>
  <script type="text/javascript" src="../bitcoinjs/crypto-js/ripemd160.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/prng4.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/rng.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/jsbn.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/jsbn2.js"></script>

  <script type="text/javascript" src="../bitcoinjs/jsbn/ec.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/sec.js"></script>
  <script type="text/javascript" src="../bitcoinjs/events/eventemitter.js"></script>
  <script type="text/javascript" src="../bitcoinjs/bitcoin.js"></script>
  <script type="text/javascript" src="../bitcoinjs/util.js"></script>
  <script type="text/javascript" src="../bitcoinjs/base58.js"></script>

  <script type="text/javascript" src="../bitcoinjs/address.js"></script>
  <script type="text/javascript" src="../bitcoinjs/ecdsa.js"></script>
  <script type="text/javascript" src="../bitcoinjs/eckey.js"></script>
  <script type="text/javascript" src="../bitcoinjs/paillier.js"></script>

  <script type="text/javascript" src="../bitcoinjs/paillier.js"></script>

    <!-- Crypto-JS -->
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/cipher-core.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/core.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/evpkdf.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/mode-cfb.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/enc-base64.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/format-hex.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/pad-nopadding.js"></script>

  <!-- for crypto, asn1, asn1x509 -->

  <script src="http://yui.yahooapis.com/2.9.0/build/yahoo/yahoo-min.js"></script>

  <!-- jsrsasign -->

  <script language="JavaScript" type="text/javascript" src="../jsrsasign/base64x-1.1.min.js"></script>

  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/prng4.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/rng.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/sha1.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/rsa.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/rsa2.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/base64.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/asn1hex-1.1.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/rsapem-1.1.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/rsasign-1.2.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/x509-1.1.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/pkcs5pkey-1.0.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/asn1-1.0.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/asn1x509-1.0.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/crypto-1.1.js"></script>

  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/ec.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/ec-patch.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ecdsa-modified-1.0.js"></script>

  <script language="JavaScript" type="text/javascript" src="../jsrsasign/keyutil-1.0.js"></script>

  <!-- jQuery -->

  <script type="text/javascript" src="/jquery/jquery-1.11.1.min.js"></script>

<script>

var oraclePrivkey0 = "$ORACLE_PRIVKEY"
var oraclePrivkey = atob(oraclePrivkey0);

var Tag = document.getElementById("oracle_privkey");
if(Tag) Tag.innerHTML = oraclePrivkey;


Bitcoin.ECKey.prototype.getExportedPublicKey = function () {
    var hash = this.getPub();
    while (hash.length < 32) hash.unshift(0);
    var checksum = Crypto.SHA256(Crypto.SHA256(hash, {asBytes: true}), {asBytes: true});
    var bytes = hash.concat(checksum.slice(0,4));
    return Bitcoin.Base58.encode(bytes);
};

function fail(text) {
    var ws = document.getElementById("status");
    if(ws) ws.innerHTML = "<font color=red>" + text + "</font>";
}

function sign() {
    var contractId = "$CONTRACT_ID";
    var toAddress = "$TO_ADDRESS";
    var oraclePrivkey0 = "$ORACLE_PRIVKEY"
    var oraclePrivkey = atob(oraclePrivkey0);;
    var encEventPrivkey = "$ENC_EVENT_PRIVKEY";
    var t3Sighash = "$T3-SIGHASH";
    var t3Raw = "$T3-RAW";

    var signerECPrivkey0 = document.getElementById("signer_ec_privkey");
    var signerECPrivkeyB58Check = signerECPrivkey0.value;

    var signerRSAPrivkey0 = document.getElementById("signer_rsa_privkey");
    // Fucking PEM and pasting. hurrrrr
    var firstSplits  = signerRSAPrivkey0.value.split("-----BEGIN RSA PRIVATE KEY-----");
    var secondSplits = firstSplits[1].split("-----END RSA PRIVATE KEY-----");

    var signerRSAPrivkey =
        "-----BEGIN RSA PRIVATE KEY-----" +
        secondSplits[0].split(" ").join("\n") +
        "-----END RSA PRIVATE KEY-----";

    var rsaOraclePrivkey = new RSAKey();
    var rsaSignerPrivkey = new RSAKey();
    rsaOraclePrivkey = KEYUTIL.getKey(oraclePrivkey,    "PKCS1PRV");
    rsaSignerPrivkey = KEYUTIL.getKey(signerRSAPrivkey, "PKCS1PRV");

    // <<_Prefix:8/binary, EncAESKey:256/binary, CipherText1/binary>>
    console.log("encEventPrivkey: " + encEventPrivkey);
    var encAESKey = encEventPrivkey.substring(16, 528);
    var cipherText1 = encEventPrivkey.substring(528);

    var AESKey = rsaSignerPrivkey.decryptOAEP(encAESKey);

    var AESConfig = { iv: CryptoJS.enc.Hex.parse('00000000000000000000000000000000') };

    // hurrdurr engage encodings / types madness
    var cipherText1WordArray = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Hex.parse(cipherText1));
    var AESKeyWordArray      = CryptoJS.enc.Base64.parse(btoa(AESKey));

    var plaintext1Object = CryptoJS.AES.decrypt(cipherText1WordArray, AESKeyWordArray, AESConfig);
    plaintext1 = plaintext1Object.toString(CryptoJS.enc.Hex);
    console.log("plaintext1: " + plaintext1);

    // Yo Dawg, we heard you like encryption.
    var encAESKey2 = plaintext1.substring(16, 528);
    var cipherText2 = plaintext1.substring(528);

    var AESKey2 = rsaOraclePrivkey.decryptOAEP(encAESKey2);

    var cipherText2WordArray = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Hex.parse(cipherText2));
    var AESKeyWordArray2 = CryptoJS.enc.Base64.parse(btoa(AESKey2));

    var plaintext2Object = CryptoJS.AES.decrypt(cipherText2WordArray, AESKeyWordArray2, AESConfig);
    var eventECPrivkeyB58Check = atob(plaintext2Object.toString(CryptoJS.enc.Base64));

    console.log("eventECPrivkeyB58Check: " + eventECPrivkeyB58Check);
    console.log("signerECPrivkeyB58Check: " + signerECPrivkeyB58Check);

    // validate input
    
    var eventECKey0;
    try {
        eventECKey0 = Bitcoin.ECKey.decodeString(eventECPrivkeyB58Check);
    } catch (err) {
        console.log(err);
        fail("bad key: " + err);
        return;
    }
    var signerECKey0;
    try {
        signerECKey0 = Bitcoin.ECKey.decodeString(signerECPrivkeyB58Check);
    } catch (err) {
        console.log(err);
        fail("bad key: " + err);
        return;
    }

    var eventECKey  = new Bitcoin.ECKey(eventECKey0);
    var signerECKey = new Bitcoin.ECKey(signerECKey0);

    // Unlike signing of T2, here the same sighash is signed twice:
    // signed with winner's EC privkey
    var signature1Bytes = signerECKey.sign(t3Sighash);
    var signature1 = Crypto.util.bytesToHex(signature1Bytes);

    // signed with decrypted event EC privkey
    var signature2Bytes = eventECKey.sign(t3Sighash);
    var signature2 = Crypto.util.bytesToHex(signature2Bytes);

    // Call to Mw
    // ----------
    var url = "http://127.0.0.1:8081/submit-t3-signatures/{" +
        "\"contract_id\":\"" + encodeURIComponent(contractId) + "\"," +
        "\"t3_raw\":\"" + encodeURIComponent(t3Raw) + "\"," +
        "\"t3_signature1\":\"" + encodeURIComponent(signature1) + "\"," +
        "\"t3_signature2\":\"" + encodeURIComponent(signature2) + "\"}";

    console.log("url: " + url);

    var Tag = document.getElementById("url");
    if(Tag) Tag.innerHTML = "<font color=blue>" + url + "</font>";

    $.ajax({
        url: url,
        success: function(response,status,xhr) {
            $( "#result" ).html(xhr.responseText)
        }
    });

    // Print an ok to screen and JS console.
    // -------------------------------------
    console.log(ok = "ok.");
    var oktag = document.getElementById("ok");
    if(oktag) oktag.innerHTML = "<font color=lime>" + ok + "</font>";

    console.log("ok");
}

</script>
