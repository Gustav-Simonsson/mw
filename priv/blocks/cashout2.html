<div class=main>

  <h3>Cashout</h3>

  <p>
    <ll>
      <li>
        $HEADLINE
      </li>
    </ll>
  </p>

    <li><b>1. To Address (receives winnings) (base58check) :</b>
    <br />
    <p style="font-family: monospace; white-space: pre;"> $TO_ADDRESS </p>
    </li>

    <li><b>2. Revealed Oracle RSA Private Key (PEM) :</b>
    <br />
    <p id=oracle_privkey style="font-family: monospace; white-space: pre;"><font color=red>[A key should appear here.]</font></p>
    </li>

    <li><b>3. Encrypted Event Private Key (Hex) :</b>
    <br />
    <p style="font-family: monospace; white-space: pre;"> $ENC_EVENT_PRIVKEY </p>
    </li>

    <li><b>4. T3 Raw (Hex) :</b>
    <br />
    <p style="font-family: monospace; white-space: pre;"> $T3-RAW </p>
    </li>

    <li><b>5. T3 Sighash (Hex) :</b>
    <br />
    <p style="font-family: monospace; white-space: pre;"> $T3-SIGHASH </p>
    </li>

  <h4>Instructions</h4>
  <p>
    <ll>
      <li>
        Please paste your EC PRIVATE KEY that you copied earlier:
        <textarea id=signer_ec_privkey class=mark>5KWgBs1mP5EtTJyamkoKosKNcLuu6mTwcBywCUjWcX5ARnMC72k</textarea>
        <br />
      </li>
      <li>
        Please paste your RSA PRIVATE KEY that you copied earlier:
        <textarea id=signer_rsa_privkey class=mark>-----BEGIN RSA PRIVATE KEY----- MIIEowIBAAKCAQEArIrme7vsPAePZ3/0bLAg13F2AmvsQL95sel5YNeIK9JTx2iS 6j9HHJOzpY9X8pFgxcZD1qERXuqdn1YGkVMBMS0pVyK4v7IOmF1KPLQoKLWSPE9r 85NDnio/7JPMQp1R1yfnnn3bdnS9g4dP9v1iOMASiz7CBRonf7jreZBy3nYAc1yF B7pwikGA/DMCzfjrozUCjR0KfM2aQybXEb+gfw/UOmulBDuKmTRe28A9DUisX/5o 4lJZttvSRSGHjuqiHNljnQWRchPSR/ujVnFwHEqXq8739JCXEKUQ2QGmM8L4pyib WVVEkgrMaptm23nyxQzUIagD/l1MXF5YHgR6CQIDAQABAoIBABP4K37MnCXCdj1z WLWvmM12i0LyfLBtuMb3j52+tDrmJ94fY0mLM07CZXtW4MXpP3sEXFud3qXOn5mO Wko9ghjP8kXsdddx4zCNM4ddDnzPrvId+w+AzsWifC2EWZKoJI2zR6JXTKwkDL8J TR736oNI75yAEfKHOWUV4OL77d+DNdjAV5cae2vVbd57AXKam3gMKj0uO9VKieL+ xsXS2zqgr6t20EV8s299XYA/Qsn5gmXKLbPwP7W9AhVm+DjhbFHbJsjpIXqWcxz0 RxgkC9ZGCc+K9nBz7/DhzR/lTTZj3xo8Svbs8eS/QJXyBjwRje1Vo4eCTRMY4OBJ +Cb4ctECgYEA6M/SlfLqQFMFoD8IAaofDR6ueqP+ao3ROIWFl2lIUk85rvmHXlBe FX2e0wAXiGo1bkjEnBB5OKvLtRl5NREGT+UEGCjDxnABQufAMl+BSQ2AK2eD2BCq n0sxEeD+UgZ2jQl5TL2JUM+yNfwybor8F7bbwUnnOisnTPK8DFjmBEUCgYEAvbpZ Fb6lGsX4n13cIZZ3jPQeOy7vIwmrk4n3/wFG56tVaOs3PqBBu9fRuW9LC71sq27s uvYqabWMQWeyzDPJe4UKBpEMn09uiokxR9eLisfZxtWZMNpViOfr4PDX6+5Zs5pU grZlOIUd/CZMNUyMxhDwrn8hD0322c7+L0CpFPUCgYAIvvXsSCngrL3DXVrRpTBx b7uiQ9Lk8drwQqPYIk5jOTKzjhA1zNMb/5Id3x0DNOo48GbibgP/ywRmE0ToZ3FT Qwk6Vx2zsLV7a/VebxQOSIGOH99mGIowXcTEJS2oqzF87uQtq9kivgq12HmUiYga 4/WxdzNGjiR10ZCa7iQF+QKBgFbXLaFrUozvon3nazOgeHX24sN6FxD1gygT1YRN 5FNzs7NDPlUW6x98iE0VKMdl25CYRBjLRdx+sYTaXxdieM1ltpIM4DcnF1SnuPvG J+PM19xPtj+LH+17IhciheJChaJUeGwf6jK1k2TvbqBSuniKFm/4Vnx31g4Z1XRx ZzLlAoGBAJsl0Hz9UyEZ5RAdsV1E//tgahJ+O3qXGtf3pKdkapc5DF8LhHQ6bQp9 JPvxSMdL/Nzziw1rz9Q8KUAdf6NAI9fEeM5kYZUkNpDkRHBemPcTyx2YUNbTw1hp ylmGiYvDOpKz7PHQ71QuhCwdM5IgO0Be+GKUwS3m1Ib3gSpUEIdV -----END RSA PRIVATE KEY-----</textarea>
        <br />
      </li>

      <li>
        Then, please click 'sign'.
      </li>
    </ll>
  </p>

  <button class=mark onClick="sign()">sign</button>

  <p>
    <a href=wrapup.html>cashout</a>
  </p>

  <hr />

  <h4>Notes</h4>
  <p>
    <ul>
      <li>
        Technically, what happens here is this:
        <ul>
          <li>
             the double-encrypted WINNING KEY is now decrypted
            <ul>
              <li>
                 .. using your personal, one time SECURITY KEY
              </li>
              <li>
                 .. and the ORACLE KEY that was released at event outcome
              </li>
              <li>
                 the resulting is the decrypted WINNING KEY.
              </li>
            </ul>
          </li>
          <li>
             This is used to unlock the waged amount in the betting contract
          </li>
            <ul>
              <li>
                 .. signing it with this WINNING KEY and also
              </li>
              <li>
                 .. signing it with your SIGNATURE KEY
              </li>
              <li>
                 .. to transfer the amount to the address you entered on the previous page.
              </li>
            </ul>
          <li>
             After you click 'sign' the Bitcoins should arrive in your wallet after about 10 minutes.
          </li>
        </ul>
      </li>
      <li>
        We never held the money, it was locked into the blockchain.
      </li>
      <li>
        The money is fully yours the moment you receive the WINNING KEY.
      </li>
        <ul>
          <li>
            .. even if you do not execute this page, you safely own the won Bitcoins
          </li>
          <li>
            .. this page mererly helps you to put the won Bitcoins back into your wallet
          </li>
          <li>
            .. but note that you might loose Bitcoins that are not moved for 10 years, or less
          </li>
        </ul>
      <li>
        Ajax call: <p id=url></p>
      </li>
      <li>
        Ajax result: <p id=result></p>
      </li>

    </ul>
  </p>

</div>


  <!-- LIBS -->

  <!-- BitcoinJS -->

  <script type="text/javascript" src="../bitcoinjs/crypto-js/crypto.js"></script>
  <script type="text/javascript" src="../bitcoinjs/crypto-js/sha256.js"></script>
  <script type="text/javascript" src="../bitcoinjs/crypto-js/ripemd160.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/prng4.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/rng.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/jsbn.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/jsbn2.js"></script>

  <script type="text/javascript" src="../bitcoinjs/jsbn/ec.js"></script>
  <script type="text/javascript" src="../bitcoinjs/jsbn/sec.js"></script>
  <script type="text/javascript" src="../bitcoinjs/events/eventemitter.js"></script>
  <script type="text/javascript" src="../bitcoinjs/bitcoin.js"></script>
  <script type="text/javascript" src="../bitcoinjs/util.js"></script>
  <script type="text/javascript" src="../bitcoinjs/base58.js"></script>

  <script type="text/javascript" src="../bitcoinjs/address.js"></script>
  <script type="text/javascript" src="../bitcoinjs/ecdsa.js"></script>
  <script type="text/javascript" src="../bitcoinjs/eckey.js"></script>
  <script type="text/javascript" src="../bitcoinjs/paillier.js"></script>

  <script type="text/javascript" src="../bitcoinjs/paillier.js"></script>

    <!-- Crypto-JS -->
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/cipher-core.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/core.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/evpkdf.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/mode-cfb.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/enc-base64.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/format-hex.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/pad-nopadding.js"></script>

  <!-- for crypto, asn1, asn1x509 -->

  <script src="http://yui.yahooapis.com/2.9.0/build/yahoo/yahoo-min.js"></script>

  <!-- jsrsasign -->

  <script language="JavaScript" type="text/javascript" src="../jsrsasign/base64x-1.1.min.js"></script>

  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/prng4.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/rng.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/sha1.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/rsa.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/rsa2.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/base64.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/asn1hex-1.1.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/rsapem-1.1.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/rsasign-1.2.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/x509-1.1.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/pkcs5pkey-1.0.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/asn1-1.0.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/asn1x509-1.0.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/crypto-1.1.js"></script>

  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/ec.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/ec-patch.js"></script>
  <script language="JavaScript" type="text/javascript" src="../jsrsasign/ecdsa-modified-1.0.js"></script>

  <script language="JavaScript" type="text/javascript" src="../jsrsasign/keyutil-1.0.js"></script>

  <!-- jQuery -->

  <script type="text/javascript" src="/jquery/jquery-1.11.1.min.js"></script>

<script>

var oraclePrivkey0 = "$ORACLE_PRIVKEY"
var oraclePrivkey = atob(oraclePrivkey0);

var Tag = document.getElementById("oracle_privkey");
if(Tag) Tag.innerHTML = oraclePrivkey;


Bitcoin.ECKey.prototype.getExportedPublicKey = function () {
    var hash = this.getPub();
    while (hash.length < 32) hash.unshift(0);
    var checksum = Crypto.SHA256(Crypto.SHA256(hash, {asBytes: true}), {asBytes: true});
    var bytes = hash.concat(checksum.slice(0,4));
    return Bitcoin.Base58.encode(bytes);
};

function fail(text) {
    var ws = document.getElementById("status");
    if(ws) ws.innerHTML = "<font color=red>" + text + "</font>";
}

function sign() {
    var contractId = "$CONTRACT_ID";
    var toAddress = "$TO_ADDRESS";
    var oraclePrivkey0 = "$ORACLE_PRIVKEY"
    var oraclePrivkey = atob(oraclePrivkey0); //.replace(/(\r\n|\n|\r)/gm, "\n");
    var encEventPrivkey = "$ENC_EVENT_PRIVKEY";
    var t3Sighash = "$T3-SIGHASH";
    var t3Raw = "$T3-RAW";

    var signerECPrivkey0 = document.getElementById("signer_ec_privkey");
    var signerECPrivkeyB58Check = signerECPrivkey0.value;

    var signerRSAPrivkey0 = document.getElementById("signer_rsa_privkey");
    // Fucking PEM and pasting. gief ECIES.
    var firstSplits  = signerRSAPrivkey0.value.split("-----BEGIN RSA PRIVATE KEY-----");
    var secondSplits = firstSplits[1].split("-----END RSA PRIVATE KEY-----");

    var signerRSAPrivkey =
        "-----BEGIN RSA PRIVATE KEY-----" +
        secondSplits[0].split(" ").join("\n") +
        "-----END RSA PRIVATE KEY-----";

    var rsaOraclePrivkey = new RSAKey();
    var rsaSignerPrivkey = new RSAKey();
    rsaOraclePrivkey = KEYUTIL.getKey(oraclePrivkey,    "PKCS1PRV");
    rsaSignerPrivkey = KEYUTIL.getKey(signerRSAPrivkey, "PKCS1PRV");

    // <<_Prefix:8/binary, EncAESKey:256/binary, CipherText1/binary>>
    var encAESKey = encEventPrivkey.substring(16, 528);
    var cipherText1 = encEventPrivkey.substring(528);

    console.log("encAESKey: " + encAESKey);
    console.log("cipherText1: " + cipherText1);

    var AESKey = rsaSignerPrivkey.decryptOAEP(encAESKey);

    console.log("AESKey: " + AESKey);

    // hngghff
    var cipherText1WordArray = { ciphertext: cipherText1 }; // CryptoJS.enc.Hex.parse(cipherText1);

    var AESKeyWordArray = CryptoJS.enc.Base64.parse(btoa(AESKey));

    var AESConfig =
        {
            iv: CryptoJS.enc.Hex.parse("00000000000000000000000000000000")
            // formatter: CryptoJS.format.Hex
            // mode: CryptoJS.mode.CBC,
            // padding: CryptoJS.pad.NoPadding
        };

    var plaintext1 = CryptoJS.AES.decrypt(cipherText1WordArray, AESKeyWordArray, AESConfig);

    console.log("plaintext1: " + plaintext1.toString(CryptoJS.enc.Hex));

    var eventECPrivkey;

    // validate input
    var signerECKey0;
    try {
        signerECKey0 = Bitcoin.ECKey.decodeString(signerECPrivkeyB58Check);
    } catch (err) {
        console.log(err);
        fail("bad key: " + err);
        return;
    }

    var signerECKey = new Bitcoin.ECKey(signerECKey0);
    signerECKey.setCompressed(true);
    var signerECPubkeyB58Check = signerECKey.getExportedPublicKey();

    // Unlike signing of T2, here the same sighash is signed twice:
    // signed with winner's EC privkey
    var signature1Bytes = signerECKey.sign(t3Sighash);
    var signature1 = Crypto.util.bytesToHex(signature1Bytes);

    // signed with decrypted event EC privkey
    var signature2Bytes = eventECPrivkey.sign(t3Sighash);
    var signature2 = Crypto.util.bytesToHex(signature2Bytes);

    // Call to Mw
    // ----------
    var url = "http://127.0.0.1:8081/submit-t2-signature/{" +
        "\"contract_id\":\"" + encodeURIComponent(contractId) + "\"," +
        "\"t3_raw\":\"" + encodeURIComponent(t3Raw) + "\"," +
        "\"t3_signature1\":\"" + encodeURIComponent(signature1) + "\",}" +
        "\"t3_signature2\":\"" + encodeURIComponent(signature2) + "\"}";

    console.log("url: " + url);

    var Tag = document.getElementById("url");
    if(Tag) Tag.innerHTML = "<font color=blue>" + url + "</font>";

    $.ajax({
        url: url,
        success: function(response,status,xhr) {
            $( "#result" ).html(xhr.responseText)
        }
    });

    // Print an ok to screen and JS console.
    // -------------------------------------
    console.log(ok = "ok.");
    var oktag = document.getElementById("ok");
    if(oktag) oktag.innerHTML = "<font color=lime>" + ok + "</font>";

    console.log("ok");
}

</script>
