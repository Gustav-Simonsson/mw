<div class=main>

  <h3>Sign the Bet</h3>

  <h4>Instructions</h4>
  <p>
    <ll>
      <li>
        Please Enter passphrase and click 'sign'.
      </li>
    </ll>
  </p>
  <p>
    This signs the bet. It locks the amount you wage into the blockchain
    until the bet is resolved.
  </p>

  <textarea id=signer_passphrase class=mark></textarea>

  <button class=mark onClick="sign()">sign</button>

  <p id=status>
  </p>

    <!-- a href=/followup.html>continue</a -->

  <hr />

  <h4>Notes</h4>
  <p>
    <ll>
      <li>
        If you win the bet, you will receive another key, the Winner Key.
      </li>
      <li>
        You will use the private key you copied earlier, and the Winner key,
        to transfer the won amount into your wallet.
      </li>
      <li>
        The Winner Key makes you the owner of the contract transaction.
      </li>
      <li>
        You could leave the Bitcoins there, but should transfer them into
        your wallet.
      </li>
      <li>
        That is more convenient, more visible and safer.
      </li>
      <li>
        We do not hold the money at any time, it is locked in the blockchain.
      </li>
      <li>
        T2 raw: $T2_RAW
      </li>
      <li>
        T2 sighash input 0: $T2_SIGHASH_INPUT_0
      </li>
      <li>
        T2 sighash input 1: $T2_SIGHASH_INPUT_1
      </li>
      <li>
        Giver ec pubkey: $GIVER_EC_PUBKEY
      </li>
      <li>
        Taker ec pubkey: $TAKER_EC_PUBKEY
      </li>
      <li>
        Ajax call: <p id=url></p>
      </li>
      <li>
        Ajax result: <p id=result></p>
      </li>
      <li>
        <p id=ok></p>
      </li>
    </ll>
  </p>
</div>

    <!-- LIBS -->

    <!-- BitcoinJS 0.1.3 -->
    
    <script type="text/javascript" src="../bitcoinjs_0.1.3/jsbn/prng4.js"></script> 
    <script type="text/javascript" src="../bitcoinjs_0.1.3/jsbn/rng.js"></script>
    <script type="text/javascript" src="../bitcoinjs_0.1.3/jsbn/jsbn.js"></script>
    <script type="text/javascript" src="../bitcoinjs_0.1.3/jsbn/jsbn2.js"></script>
    <script type="text/javascript" src="../bitcoinjs_0.1.3/jsbn/ec.js"></script>
    <script type="text/javascript" src="../bitcoinjs_0.1.3/jsbn/sec.js"></script>

    <script type="text/javascript" src="../bitcoinjs_0.1.3/crypto-js/crypto.js"></script>
    
    <!-- BitcoinJS 1.0.2 -->

    <script type="text/javascript" src="../bitcoinjs_1.0.2-min.js"></script>

    <!-- bs58check 1.2.1 -->

    <script type="text/javascript" src="../bs58check.min.js"></script>

    <!-- Crypto-JS -->
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/cipher-core.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/core.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/evpkdf.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/mode-cfb.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/enc-base64.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha1.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha256.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/format-hex.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/tripledes.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/pad-nopadding.js"></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>

    <!-- for crypto, asn1, asn1x509 -->
    <script src="http://yui.yahooapis.com/2.9.0/build/yahoo/yahoo-min.js"></script>
    <!-- for asn1x509(stohex) -->
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/base64x-1.1.min.js"></script>

    <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/prng4.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/rng.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/rsa.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/rsa2.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/base64.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/asn1hex-1.1.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/rsapem-1.1.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/rsasign-1.2.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/x509-1.1.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/pkcs5pkey-1.0.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/asn1-1.0.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/asn1x509-1.0.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/crypto-1.1.js"></script>

    <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/ec.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/ext/ec-patch.js"></script>
    <script language="JavaScript" type="text/javascript" src="../jsrsasign/ecdsa-modified-1.0.js"></script>

    <script language="JavaScript" type="text/javascript" src="../jsrsasign/keyutil-1.0.js"></script>

    <!-- jQuery -->

    <script type="text/javascript" src="/jquery/jquery-1.11.1.min.js"></script>

    <script>

// http://stackoverflow.com/questions/3745666/how-to-convert-from-hex-to-ascii-in-javascript
function hex2a(hexx) {
    var hex = hexx.toString();//force conversion
    var str = '';
    for (var i = 0; i < hex.length; i += 2)
        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
    return str;
}

function fail(text) {
    var ws = document.getElementById("status");
    if(ws) ws.innerHTML = "<font color=red>" + text + "</font>";
}

function sign() {

    console.log("sign");

    var t2Raw                 = "$T2_RAW";
    var t2SighashInput0       = "$T2_SIGHASH_INPUT_0";
    var t2SighashInput1       = "$T2_SIGHASH_INPUT_1";
    var giverECPubkeyB58Check = "$GIVER_EC_PUBKEY";
    var takerECPubkeyB58Check = "$TAKER_EC_PUBKEY";
    var serverHost            = "$SERVER_HOST";
    console.log("serverHost: " + serverHost);

    // TODO: here we hardcode the taker signing. Figure out how to determine if
    // we have giver or taker BEFORE we can match on the decrypted EC key
    var signerEncECPrivkey    = "$TAKER_ENC_EC_PRIVKEY";

    console.log("check");

    var signerPassphrase0 = document.getElementById("signer_passphrase");
    var signerPassphrase = signerPassphrase0.value;

    console.log("signerPassphrase: " + signerPassphrase);
    console.log("signerEncECPrivkey: " + signerEncECPrivkey);

    var signerPrivkeyHex = CryptoJS.AES.decrypt(signerEncECPrivkey, signerPassphrase);
    var signerPrivkeyB58Check = hex2a(signerPrivkeyHex);

    console.log("signerPrivkeyB58Check: " + signerPrivkeyB58Check);

    // validate input
    var signerECKey;
    try {
        signerECKey = Bitcoin.ECKey.fromWIF(signerPrivkeyB58Check);
    } catch (err) {
        console.log(err);
        fail("bad key: " + err + " (most likely passphrase is wrong)");
        return;
    }

    var signerECPubkeyB58Check = Bs58check.encode(signerECKey.pub.toBuffer());

    console.log("EC pasted pub key (base58): " + signerECPubkeyB58Check);
    console.log("EC giver pub key (base58): " + giverECPubkeyB58Check);
    console.log("EC taker pub key (base58): " + takerECPubkeyB58Check);

    // is it the giver or taker we are serving here?
    var isGiver = signerECPubkeyB58Check == giverECPubkeyB58Check;
    var isTaker = signerECPubkeyB58Check == takerECPubkeyB58Check;

    // sign for giver
    if(isGiver) {
        var t2SighashInput0Buf = Bitcoin.convert.wordArrayToBuffer(CryptoJS.enc.Hex.parse(t2SighashInput0));
        var signature = signerECKey.sign(t2SighashInput0Buf);
        // Atomic batteries to power, turbines to speed, engage encoders!
        var signatureHex = CryptoJS.enc.Hex.stringify(Bitcoin.convert.bufferToWordArray(signature.toDER()));
        console.log("signature (giver): " + signatureHex);
    }

    // sign for taker
    else if(isTaker) {
        var t2SighashInput1Buf = Bitcoin.convert.wordArrayToBuffer(CryptoJS.enc.Hex.parse(t2SighashInput1));
        console.log("t2SighashInput1Buf: " + Crypto.util.bytesToHex(t2SighashInput1Buf));
        var signature = signerECKey.sign(t2SighashInput1Buf);
        var signatureHex = CryptoJS.enc.Hex.stringify(Bitcoin.convert.bufferToWordArray(signature.toDER()));
        console.log("signature (taker): " + signatureHex);
    }

    else {
        fail("wrong key");
        return;
    }

    // Call to Mw
    // ----------

    var contract_id = "$CONTRACT_ID";
    var url = "http://" + serverHost + ":8081/submit-t2-signature/{" +
        "\"contract_id\":\"" + encodeURIComponent(contract_id) + "\"," +
        "\"ec_pubkey\":\"" + encodeURIComponent(signerECPubkeyB58Check) + "\"," +
        "\"t2_signature\":\"" + encodeURIComponent(signatureHex) + "\"}";

    console.log("url: " + url);

    var tag = document.getElementById("url");
    if(tag) tag.innerHTML = "<font color=blue>" + url + "</font>";

    $.ajax({
        url: url,
        success: function(response,status,xhr) {
            $( "#result" ).html(xhr.responseText)
        }
    });

    // Print an ok to screen and JS console.
    // -------------------------------------
    console.log(ok = "ok.");
    var oktag = document.getElementById("ok");
    if(oktag) oktag.innerHTML = "<font color=lime>" + ok + "</font>";

    console.log("ok");
}

</script>
